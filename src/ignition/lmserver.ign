{
  "ignition": {
    "version": "3.3.0"
  },
  "passwd": {
    "users": [
      {
        "name": "core",
        "sshAuthorizedKeys": [
          "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMFJhPTPfNQuNCuz9AESupcGOwLtg8Xp+qTnv2+qU94O",
          "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCuyHMuKWZIxf63X1Ve6nU6+D/Ku+Y6c2pC8OYMDbzQrxr1AQCvoxP/zVimLbl4cur66GXE3RqcRH6UHC1q6YR2vlWBcZvDlojnHWRmqvcFlsuv7RxdF5DVatzrfQ6l1m0jy+Ey3djBGKwH5fIxKTpMZVkERFXYSNDLwyMqTisbBI9e32nOHFeG5dcH6mdloAyICbdMnDTn5pl1ztjEOqZ+TKtv0ZEf4o0iHMCKFwJBJnJ2OGTqNycjt6VeTPaMdpGetfCxCuA7lmdGV6IoooEkxKTp9J1+DBmTTGgo1ivfb6EZVSL6EQysieL+eYhcASKkiKaoQOylqysHbk49TJUBMX2H3yLq9N80h6dhDjtdWtCpuaD0KKpnxF5J3agi9z2gywVgzv38hik2ApE1T0ny/ZtwnnXOw3sNMaS6yBp9yw/KqsuKBrSqDYufqQbsce/sAjzR4B4ELauvol0AvlK+5gSDTZoDI6VgbOyJkFVFZbkOqAXTZZ/cBPJ8+ZzSBsNjW6YHvl7mJsdi9ZuUT2OhH2CKF3+rcVaBBcdzMqSMcwUWYf5J4n7yTleCuPau+klkHzM+QbHEPN+65dSqdk0nwgSiwK0OaalHuYNVlNPyji1lkLVLFwsgpE7lIpRxPrYOI6fVY/Fo0EhW3oIktvyohKRF1TaISsILRr2m/b7VLQ==",
          "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCse8TLb47f+zddmzm0EvO6+RK8eeQouClEFA33ftG6+ioiJxkNf+vXwtWVlmA4JzwhLDQ5tKk+SQ9OTg/JMB8O9VfaK9LHxhJhLdiNo+P8W/vK9BI6CNCA1F+rbzN3OtEavYum7eHxeUrnYM+VkGyUpi5zmbHYF30VgxYeLMoK66eriFo+EHoQwv137uUgGYxe1BLGwkHjWdZ6wgjPkZTu4QoAsdxptVZH16TsFJKEQJdetJbJQ+I86yPjZ4AU5ImzdWUbUA4ic8gIZDhZeLz2UCmRB/EilNVKzQb+m54rE+cRH7f63zcEkqnAb5Ugz+XRMtdtqxcx2x9Eza2ohk8ZblyE8s3D2c4KR4YKzZJhuakK/sQ9FKOJo6vy2G6Mq1PMUhMF3rn+whUzXBpV2A0XK8P0H7/D+7zsGnQH+NZb6akgE+SqonL+zK430xWhWvoE7irtPh9CeG8+AF9OD+nbGBs22HpXCeR+yW2tPfJQtHLBOkaWyzJIsqfl4cMWaCRMnRKl/QEJuu9dG3rtOcZyBvkBnKd0X1GNIN5t1BMuhKghkipBgrG2oMM3hBRafHafrg26ikIImuImqVvaWZWeKKjU5tsivu/PELa4vyF/PqJ7meFqf1V2Jpw2Z21nSVQsgXK34Kbx5r6GSIdea+9cdEsJabKS7VrqwmSY8NjCZQ=="
        ]
      }
    ]
  },
  "storage": {
    "directories": [
      {
        "path": "/storage"
      }
    ],
    "files": [
      {
        "path": "/etc/hostname",
        "contents": {
          "compression": "",
          "source": "data:,lmserver"
        },
        "mode": 420
      }
    ],
    "links": [
      {
        "path": "/etc/localtime",
        "target": "/usr/share/zoneinfo/Europe/Amsterdam"
      }
    ]
  },
  "systemd": {
    "units": [
      {
        "contents": "[Unit]\nDescription=Mount storage directory\n\n[Mount]\nWhat=/dev/disk/by-label/storage\nWhere=/storage\nType=btrfs\nOptions=defaults,nofail,noatime,autodefrag\n\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "storage.mount"
      },
      {
        "contents": "[Unit]\nDescription=BTRFS scrub the /storage filesystem\n\n[Service]\nExecStart=btrfs scrub start -Bd /dev/disk/by-label/storage\n\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "scrubber.service"
      },
      {
        "contents": "[Unit]\nDescription=Scrubber service timer\n\n[Timer]\nOnCalendar=monthly\nAccuracySec=12h\nPersistent=true\nUnit=scrubber.service\n\n[Install]\nWantedBy=basic.target\n",
        "enabled": true,
        "name": "scrubber.timer"
      },
      {
        "enabled": true,
        "name": "docker.service"
      },
      {
        "contents": "[Unit]\nDescription=Portainer Service\nAfter=docker.service\nRequires=docker.service\n\n[Service]\nRestart=always\nExecStartPre=mkdir -p /storage/docker/portainer\nExecStartPre=-/usr/bin/docker rm -f portainer\nExecStartPre=-/usr/bin/docker network create --attachable lmserver\nExecStartPre=-/usr/bin/docker pull portainer/portainer-ce:alpine\nExecStart=/usr/bin/docker run \\\n  --name portainer \\\n  --rm \\\n  --volume /storage/docker/portainer:/data \\\n  --volume /var/run/docker.sock:/var/run/docker.sock:ro \\\n  --log-driver syslog \\\n  --log-opt 'syslog-address=udp://127.0.0.1:515' \\\n  --log-opt 'tag={{.Name}}/{{.FullID}}' \\\n  --network lmserver \\\n  --publish 9000:9000 \\\n  --label traefik.enable=true \\\n  --label traefik.http.routers.portainer.entrypoints=websecure \\\n  --label traefik.http.routers.portainer.rule='Host(`lmserver.mdekort.nl`) \u0026\u0026 PathPrefix(`/portainer`)' \\\n  --label traefik.http.services.portainer.loadbalancer.server.port=9000 \\\n  --label traefik.http.routers.portainer.tls=true \\\n  --label traefik.http.routers.portainer.tls.certresolver=mdekort \\\n  --label traefik.http.middlewares.portainer_stripprefix.stripprefix.prefixes=/portainer \\\n  --label traefik.http.middlewares.portainer_stripprefix.stripprefix.forceslash=false \\\n  --label traefik.http.routers.portainer.middlewares=portainer_stripprefix@docker \\\n  portainer/portainer-ce:alpine\n\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "docker.portainer.service"
      }
    ]
  }
}
